name: Moodle Plugin - Security & Coding Standards Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  moodle_security_check:
    name: Moodle Plugin Security & Standards
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Clonar el repositorio
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Instalar PHP y herramientas necesarias
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'  # Ajusta segÃºn tu versiÃ³n Moodle (8.0â€“8.2 es lo usual)
          tools: composer, phpstan, phpcs
          extensions: mbstring, mysqli, xml, curl, intl, zip, json

      # 3ï¸âƒ£ Validar archivo version.php
      - name: Validate version.php (minimum Moodle version)
        run: |
          echo "ğŸ” Verificando archivo version.php..."
          php -r '
            $plugin = new stdClass(); // Crear antes de incluir
            include "version.php";
            if (!isset($plugin->requires)) {
                echo "âŒ ERROR: No se encontrÃ³ \$plugin->requires en version.php\n";
                exit(1);
            }
            if ($plugin->requires < 2020042000) {
                echo "âš ï¸ Advertencia: Moodle requerido muy antiguo (" . $plugin->requires . "). Considera actualizar a Moodle 4.x o posterior.\n";
                exit(0); # no falla, solo advierte
            }
            echo "âœ… version.php vÃ¡lido (Moodle >= 4.0)\n";
          '

      # 4ï¸âƒ£ Instalar Moodle Coding Standards (desde GitHub)
      - name: Install Moodle coding standards (PHP CodeSniffer)
        run: |
          echo "ğŸ“¦ Instalando moodlehq/moodle-codesniffer desde GitHub..."
          git clone https://github.com/moodlehq/moodle-codesniffer.git /tmp/moodle-codesniffer
          phpcs --config-set installed_paths /tmp/moodle-codesniffer
          echo "ğŸ“˜ EstÃ¡ndares instalados:"
          phpcs -i

      # 5ï¸âƒ£ Ejecutar PHP CodeSniffer con estÃ¡ndar Moodle
      - name: Run Moodle CodeSniffer
        run: |
          echo "ğŸ” Verificando estÃ¡ndares de codificaciÃ³n Moodle..."
          phpcs --standard=Moodle --extensions=php --ignore=vendor,tests . || true
        continue-on-error: true

      # 6ï¸âƒ£ Ejecutar PHPStan (AnÃ¡lisis estÃ¡tico de seguridad)
      - name: Run PHPStan (Static Analysis)
        run: |
          echo "ğŸ§  Ejecutando PHPStan para anÃ¡lisis estÃ¡tico..."
          phpstan analyse --level=max . || true
        continue-on-error: true

      # 7ï¸âƒ£ Mostrar resumen final
      - name: Summary report
        run: |
          echo "-----------------------------------------"
          echo "âœ… VerificaciÃ³n completada"
          echo "ğŸ“˜ Moodle coding standards: ejecutado"
          echo "ğŸ›¡ï¸  PHPStan: ejecutado"
          echo "-----------------------------------------"
