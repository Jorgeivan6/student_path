name: Moodle Plugin - Security & Coding Standards Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  moodle_security_check:
    name: Moodle Plugin Security & Standards
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Clonar el repositorio
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Configurar PHP y herramientas
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer, phpstan, phpcs
          extensions: mbstring, mysqli, xml, curl, intl, zip, json

      # 3ï¸âƒ£ Validar archivo version.php
      - name: Validate version.php (minimum Moodle version)
        run: |
          echo "ğŸ” Verificando archivo version.php..."
          php -r '
            $plugin = new stdClass();
            include "version.php";
            if (!isset($plugin->requires)) {
                echo "âŒ ERROR: No se encontrÃ³ \$plugin->requires en version.php\n";
                exit(1);
            }
            if ($plugin->requires < 2020042000) {
                echo "âš ï¸ Advertencia: Moodle requerido muy antiguo (" . $plugin->requires . "). Considera actualizar a Moodle 4.x o posterior.\n";
                exit(0);
            }
            echo "âœ… version.php vÃ¡lido (Moodle >= 4.0)\n";
          '

      # 4ï¸âƒ£ Instalar Moodle Coding Standards (desde ZIP, rama main)
      - name: Install Moodle coding standards (PHP CodeSniffer)
        run: |
          echo "ğŸ“¦ Descargando moodlehq/moodle-codesniffer ZIP (rama main)..."
          curl -L https://github.com/moodlehq/moodle-codesniffer/archive/refs/heads/main.zip -o /tmp/moodle-codesniffer.zip
          echo "ğŸ“‚ Descomprimiendo..."
          unzip -q /tmp/moodle-codesniffer.zip -d /tmp/ || (echo "âŒ Error: No se pudo descomprimir el ZIP"; exit 1)
          phpcs --config-set installed_paths /tmp/moodle-codesniffer-main
          echo "ğŸ“˜ EstÃ¡ndares instalados:"
          phpcs -i

      # 5ï¸âƒ£ Ejecutar PHP CodeSniffer con estÃ¡ndar Moodle
      - name: Run Moodle CodeSniffer
        run: |
          echo "ğŸ” Verificando estÃ¡ndares de codificaciÃ³n Moodle..."
          phpcs --standard=Moodle --extensions=php --ignore=vendor,tests . || true
        continue-on-error: true

      # 6ï¸âƒ£ Ejecutar PHPStan (AnÃ¡lisis estÃ¡tico)
      - name: Run PHPStan (Static Analysis)
        run: |
          echo "ğŸ§  Ejecutando PHPStan para anÃ¡lisis estÃ¡tico..."
          phpstan analyse --level=max . || true
        continue-on-error: true

      # 7ï¸âƒ£ Guardar resultados como artefactos
      - name: Save reports as artifacts
        if: always()
        run: |
          mkdir -p reports
          phpcs --standard=Moodle --report=full --report-file=reports/phpcs-report.txt . || true
          phpstan analyse --error-format=table > reports/phpstan-report.txt || true
        continue-on-error: true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: moodle-security-reports
          path: reports/

      # 8ï¸âƒ£ Mostrar resumen final
      - name: Summary report
        run: |
          echo "-----------------------------------------"
          echo "âœ… VerificaciÃ³n completada"
          echo "ğŸ“˜ Moodle coding standards: ejecutado"
          echo "ğŸ›¡ï¸  PHPStan: ejecutado"
          echo "ğŸ“‚ Reportes guardados como artefactos"
          echo "-----------------------------------------"
