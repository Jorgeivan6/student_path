name: Moodle Plugin - Security & Coding Standards Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  moodle_security_check:
    name: Moodle Plugin Security & Standards
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'  # Ajusta segÃºn la versiÃ³n de Moodle que uses (8.0â€“8.2)
          tools: composer, phpstan, phpcs
          extensions: mbstring, mysqli, xml, curl, intl, zip, json

      - name: Validate version.php (minimum Moodle version)
        run: |
          echo "ğŸ” Verificando archivo version.php..."
          php -r '
            $plugin = new stdClass(); // ğŸ§  crear antes de incluir
            include "version.php";
            if (!isset($plugin->requires)) {
                echo "âŒ ERROR: No se encontrÃ³ \$plugin->requires en version.php\n";
                exit(1);
            }
            if ($plugin->requires < 2020042000) {
                echo "âš ï¸ Advertencia: Moodle requerido muy antiguo (" . $plugin->requires . "). Considera actualizar a Moodle 4.x o posterior.\n";
                exit(0); # no falla, solo advierte
            }
            echo "âœ… version.php vÃ¡lido (Moodle >= 4.0)\n";
          '

      - name: Install Moodle coding standards (PHP CodeSniffer)
        run: |
          echo "ğŸ“¦ Instalando moodlehq/moodle-codesniffer..."
          composer global require "moodlehq/moodle-codesniffer"
          ~/.composer/vendor/bin/phpcs --config-set installed_paths ~/.composer/vendor/moodlehq/moodle-codesniffer

      - name: Run Moodle CodeSniffer
        run: |
          echo "ğŸ” Verificando estÃ¡ndares de codificaciÃ³n Moodle..."
          ~/.composer/vendor/bin/phpcs --standard=Moodle --extensions=php --ignore=vendor,tests . || true
        continue-on-error: true

      - name: Run PHPStan (Static Analysis)
        run: |
          echo "ğŸ” Ejecutando PHPStan..."
          phpstan analyse --level=max . || true
        continue-on-error: true

      - name: Summary report
        run: |
          echo "-----------------------------------------"
          echo "âœ… VerificaciÃ³n completada"
          echo "ğŸ“˜ Moodle coding standards: ejecutado"
          echo "ğŸ›¡ï¸  PHPStan: ejecutado"
          echo "-----------------------------------------"
