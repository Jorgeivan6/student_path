name: üîí Moodle Security & Standards Check

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch: # Permite ejecutar manualmente

env:
  MOODLE_BRANCH: MOODLE_404_STABLE
  PHP_VERSION: '8.1'

jobs:
  security_analysis:
    name: üõ°Ô∏è An√°lisis de Seguridad y Est√°ndares
    runs-on: ubuntu-latest
    
    steps:
      # 1Ô∏è‚É£ Clonar el repositorio
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Configurar PHP y herramientas
      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer, phpstan, phpcs, psalm
          extensions: mbstring, mysqli, xml, curl, intl, zip, json, gd, soap

      # 3Ô∏è‚É£ Clonar Moodle core para validaciones
      - name: üì• Clone Moodle core
        run: |
          echo "üì• Clonando Moodle core para validaciones..."
          git clone --depth=1 --branch=${{ env.MOODLE_BRANCH }} https://github.com/moodle/moodle.git /tmp/moodle

      # 4Ô∏è‚É£ Validar estructura del plugin
      - name: üèóÔ∏è Validate plugin structure
        run: |
          echo "üèóÔ∏è Validando estructura del plugin..."
          
          # Verificar archivos obligatorios
          required_files=("version.php")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå ERROR: Archivo obligatorio '$file' no encontrado"
              exit 1
            fi
          done
          
          # Verificar version.php
          php -r '
            $plugin = new stdClass();
            if (file_exists("version.php")) {
              include "version.php";
              
              // Validar campos obligatorios
              $required_fields = ["version", "component"];
              foreach ($required_fields as $field) {
                if (!isset($plugin->$field)) {
                  echo "‚ùå ERROR: Campo obligatorio \$plugin->$field no encontrado en version.php\n";
                  exit(1);
                }
              }
              
              // Validar versi√≥n de Moodle m√≠nima (recomendado 4.0+)
              if (isset($plugin->requires) && $plugin->requires < 2022042000) {
                echo "‚ö†Ô∏è ADVERTENCIA: Versi√≥n de Moodle muy antigua. Recomendado: Moodle 4.0+\n";
              }
              
              echo "‚úÖ Estructura del plugin v√°lida\n";
            } else {
              echo "‚ùå ERROR: version.php no encontrado\n";
              exit(1);
            }
          '

      # 5Ô∏è‚É£ Verificaciones de seguridad cr√≠ticas
      - name: üîí Critical Security Checks
        run: |
          echo "üîí Ejecutando verificaciones de seguridad cr√≠ticas..."
          
          # Crear script de verificaci√≥n de seguridad
          cat > security_check.php << 'EOF'
          <?php
          function check_security_issues($directory) {
              $security_issues = [];
              $critical_issues = [];
              $files = new RecursiveIteratorIterator(
                  new RecursiveDirectoryIterator($directory, RecursiveDirectoryIterator::SKIP_DOTS)
              );
              
              foreach ($files as $file) {
                  if ($file->getExtension() !== 'php') continue;
                  
                  $content = file_get_contents($file->getPathname());
                  $relative_path = str_replace($directory . '/', '', $file->getPathname());
                  
                  // 1. CR√çTICO: Verificar que no se use eval()
                  if (preg_match('/\beval\s*\(/i', $content)) {
                      $critical_issues[] = "üö® CR√çTICO: eval() detectado en $relative_path";
                  }
                  
                  // 2. CR√çTICO: Verificar $_GET, $_POST sin validaci√≥n
                  if (preg_match('/\$_(GET|POST|REQUEST)\s*\[/', $content)) {
                      if (!preg_match('/(required_param|optional_param|clean_param)/', $content)) {
                          $critical_issues[] = "üö® CR√çTICO: Uso directo de superglobales sin validaci√≥n en $relative_path";
                      }
                  }
                  
                  // 3. ALTO: SQL directo sin prepared statements
                  if (preg_match('/\$DB\s*->\s*(execute|get_records_sql|get_record_sql)\s*\(\s*["\'][^"\']*\$/', $content)) {
                      $security_issues[] = "‚ö†Ô∏è ALTO: Posible SQL injection en $relative_path";
                  }
                  
                  // 4. ALTO: Echo/print sin escape
                  if (preg_match('/\b(echo|print)\s+\$/', $content) && !preg_match('/ajax\//', $relative_path)) {
                      if (!preg_match('/(htmlspecialchars|s\(|format_string|clean_text|format_text)/', $content)) {
                          $security_issues[] = "‚ö†Ô∏è ALTO: Posible XSS - output sin escape en $relative_path";
                      }
                  }
                  
                  // 5. MEDIO: Verificar require_login()
                  if (preg_match('/\$USER|\$COURSE/', $content) && !preg_match('/defined\(.*MOODLE_INTERNAL.*\)/', $content)) {
                      if (!preg_match('/require_login|require_course_login/', $content)) {
                          $security_issues[] = "‚ö†Ô∏è MEDIO: Posible falta de require_login() en $relative_path";
                      }
                  }
                  
                  // 6. MEDIO: Verificar MOODLE_INTERNAL
                  if (!preg_match('/defined\(.*MOODLE_INTERNAL.*\)/', $content) && 
                      !preg_match('/require.*config\.php/', $content) &&
                      !preg_match('/ajax\//', $relative_path)) {
                      $security_issues[] = "‚ö†Ô∏è MEDIO: Falta verificaci√≥n MOODLE_INTERNAL en $relative_path";
                  }
                  
                  // 7. CR√çTICO: Verificar file uploads sin validaci√≥n
                  if (preg_match('/\$_FILES/', $content)) {
                      if (!preg_match('/(file_get_draft|file_save_draft|stored_file)/', $content)) {
                          $critical_issues[] = "üö® CR√çTICO: Manejo de archivos sin API de Moodle en $relative_path";
                      }
                  }
                  
                  // 8. ALTO: Verificar include/require con variables
                  if (preg_match('/(include|require).*\$/', $content)) {
                      $security_issues[] = "‚ö†Ô∏è ALTO: Include/require con variables din√°micas en $relative_path";
                  }
              }
              
              return ['critical' => $critical_issues, 'security' => $security_issues];
          }
          
          $issues = check_security_issues('.');
          $exit_code = 0;
          
          if (!empty($issues['critical'])) {
              echo "üö® PROBLEMAS CR√çTICOS DE SEGURIDAD:\n";
              foreach ($issues['critical'] as $issue) {
                  echo "$issue\n";
              }
              $exit_code = 1;
          }
          
          if (!empty($issues['security'])) {
              echo "\n‚ö†Ô∏è PROBLEMAS DE SEGURIDAD:\n";
              foreach ($issues['security'] as $issue) {
                  echo "$issue\n";
              }
              if ($exit_code === 0) $exit_code = 2; // Warning exit code
          }
          
          if (empty($issues['critical']) && empty($issues['security'])) {
              echo "‚úÖ No se encontraron problemas de seguridad cr√≠ticos\n";
          }
          
          exit($exit_code);
          EOF
          
          php security_check.php
          SECURITY_EXIT_CODE=$?
          
          if [ $SECURITY_EXIT_CODE -eq 1 ]; then
            echo "‚ùå FALLO: Problemas cr√≠ticos de seguridad detectados"
            exit 1
          elif [ $SECURITY_EXIT_CODE -eq 2 ]; then
            echo "‚ö†Ô∏è ADVERTENCIA: Problemas de seguridad no cr√≠ticos detectados"
          fi

      # 6Ô∏è‚É£ Instalar herramientas de an√°lisis
      - name: üì¶ Install analysis tools
        run: |
          echo "üì¶ Instalando herramientas de an√°lisis..."
          
          # Moodle coding standards
          composer global config allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
          composer global require moodlehq/moodle-coding-standard --no-progress
          composer global require phpstan/phpstan --no-progress
          
          # Configurar PHPCS
          phpcs --config-set installed_paths ~/.composer/vendor/moodlehq/moodle-coding-standard
          
          echo "üìã Est√°ndares disponibles:"
          phpcs -i

      # 7Ô∏è‚É£ Ejecutar Moodle CodeSniffer
      - name: üîç Run Moodle CodeSniffer
        continue-on-error: true
        run: |
          echo "üîç Verificando est√°ndares de codificaci√≥n Moodle..."
          mkdir -p reports
          
          # Ejecutar con reporte detallado
          phpcs --standard=Moodle \
                --extensions=php \
                --ignore=vendor,tests,node_modules,.github \
                --report=full \
                --report-file=reports/phpcs-full.txt \
                . || true
          
          # Mostrar resumen en consola
          phpcs --standard=Moodle \
                --extensions=php \
                --ignore=vendor,tests,node_modules,.github \
                --report=summary \
                . || echo "‚ö†Ô∏è Se encontraron violaciones de est√°ndares de codificaci√≥n"

      # 8Ô∏è‚É£ Ejecutar PHPStan
      - name: üß† Run PHPStan analysis
        continue-on-error: true
        run: |
          echo "üß† Ejecutando PHPStan para an√°lisis est√°tico..."
          
          # Crear configuraci√≥n de PHPStan
          cat > phpstan.neon << EOF
          parameters:
              level: 6
              paths:
                  - .
              excludePaths:
                  - vendor
                  - tests
                  - node_modules
                  - .github
              ignoreErrors:
                  - '#Undefined variable: \$CFG#'
                  - '#Undefined variable: \$DB#'
                  - '#Undefined variable: \$USER#'
                  - '#Undefined variable: \$COURSE#'
                  - '#Undefined variable: \$PAGE#'
                  - '#Undefined variable: \$OUTPUT#'
          EOF
          
          phpstan analyse --configuration=phpstan.neon \
                         --error-format=table \
                         --no-progress \
                         > reports/phpstan-report.txt 2>&1 || true

      # 9Ô∏è‚É£ Verificar capacidades y permisos
      - name: üîê Check Moodle capabilities
        run: |
          echo "üîê Verificando definici√≥n de capacidades..."
          
          if [ -f "db/access.php" ]; then
            php -r '
              include "db/access.php";
              if (isset($capabilities) && is_array($capabilities)) {
                echo "‚úÖ Archivo db/access.php encontrado con " . count($capabilities) . " capacidades\n";
                
                foreach ($capabilities as $cap => $details) {
                  if (!isset($details["captype"]) || !isset($details["contextlevel"])) {
                    echo "‚ö†Ô∏è ADVERTENCIA: Capacidad $cap incompleta\n";
                  }
                  
                  // Verificar riesgos de seguridad
                  if (isset($details["riskbitmask"])) {
                    if ($details["riskbitmask"] & RISK_XSS) {
                      echo "‚ö†Ô∏è RIESGO XSS: Capacidad $cap tiene riesgo XSS\n";
                    }
                    if ($details["riskbitmask"] & RISK_SPAM) {
                      echo "‚ö†Ô∏è RIESGO SPAM: Capacidad $cap tiene riesgo de spam\n";
                    }
                  }
                }
              } else {
                echo "‚ö†Ô∏è ADVERTENCIA: No se encontraron capacidades definidas\n";
              }
            '
          else
            echo "‚ÑπÔ∏è INFO: No se encontr√≥ archivo db/access.php"
          fi

      # üîü Verificar scripts de base de datos
      - name: üóÑÔ∏è Check database scripts
        run: |
          echo "üóÑÔ∏è Verificando scripts de base de datos..."
          
          # Verificar install.php
          if [ -f "db/install.php" ]; then
            php -l db/install.php
            echo "‚úÖ db/install.php tiene sintaxis v√°lida"
          fi
          
          # Verificar upgrade.php
          if [ -f "db/upgrade.php" ]; then
            php -l db/upgrade.php
            echo "‚úÖ db/upgrade.php tiene sintaxis v√°lida"
            
            # Verificar uso de transacciones y buenas pr√°cticas
            if grep -q "upgrade_block_savepoint\|upgrade_plugin_savepoint" db/upgrade.php; then
              echo "‚úÖ Usa savepoints correctamente"
            else
              echo "‚ö†Ô∏è ADVERTENCIA: No se encontraron savepoints en upgrade.php"
            fi
            
            if grep -q "MOODLE_INTERNAL" db/upgrade.php; then
              echo "‚úÖ Incluye verificaci√≥n MOODLE_INTERNAL"
            else
              echo "‚ö†Ô∏è ADVERTENCIA: Falta verificaci√≥n MOODLE_INTERNAL"
            fi
          fi

      # 1Ô∏è‚É£1Ô∏è‚É£ Verificar archivos de idioma
      - name: üåê Check language files
        run: |
          echo "üåê Verificando archivos de idioma..."
          
          # Verificar archivo de idioma ingl√©s
          if [ -f "lang/en/block_"*.php ]; then
            php -l lang/en/block_*.php
            echo "‚úÖ Archivo de idioma ingl√©s tiene sintaxis v√°lida"
          else
            echo "‚ö†Ô∏è ADVERTENCIA: No se encontr√≥ archivo de idioma ingl√©s"
          fi
          
          # Verificar que las cadenas no contengan HTML peligroso
          if find lang/ -name "*.php" -type f -exec grep -l "<script\|javascript:" {} \; | head -1; then
            echo "üö® CR√çTICO: Se encontr√≥ JavaScript en archivos de idioma"
            exit 1
          fi

      # 1Ô∏è‚É£2Ô∏è‚É£ Crear reporte de seguridad
      - name: üìä Generate security report
        if: always()
        run: |
          echo "üìä Generando reporte de seguridad..."
          
          cat > reports/security-summary.md << EOF
          # üîí Reporte de Seguridad - Plugin Moodle
          
          ## üìÖ Informaci√≥n del an√°lisis
          - **Fecha:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          - **Rama:** \`${GITHUB_REF#refs/heads/}\`
          - **Commit:** \`${GITHUB_SHA:0:8}\`
          - **PHP:** ${{ env.PHP_VERSION }}
          - **Moodle:** ${{ env.MOODLE_BRANCH }}
          
          ## ‚úÖ Verificaciones completadas
          
          | Verificaci√≥n | Estado |
          |-------------|--------|
          | üèóÔ∏è Estructura del plugin | ‚úÖ Completado |
          | üîí Verificaciones de seguridad cr√≠ticas | ‚úÖ Completado |
          | üîç Est√°ndares de codificaci√≥n Moodle | ‚úÖ Completado |
          | üß† An√°lisis est√°tico PHPStan | ‚úÖ Completado |
          | üîê Permisos y capacidades | ‚úÖ Completado |
          | üóÑÔ∏è Scripts de base de datos | ‚úÖ Completado |
          | üåê Archivos de idioma | ‚úÖ Completado |
          
          ## üìÇ Archivos de reporte
          - \`phpcs-full.txt\` - Reporte completo de CodeSniffer
          - \`phpstan-report.txt\` - An√°lisis est√°tico PHPStan
          - \`security-summary.md\` - Este resumen
          
          ## üîó Recursos de seguridad
          - [Moodle Security Guidelines](https://docs.moodle.org/dev/Security)
          - [Moodle Coding Style](https://docs.moodle.org/dev/Coding_style)
          - [Plugin Development Best Practices](https://docs.moodle.org/dev/Plugin_development)
          EOF

      # 1Ô∏è‚É£3Ô∏è‚É£ Subir artefactos
      - name: üì§ Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: moodle-security-reports-${{ github.run_number }}
          path: reports/
          retention-days: 30

      # 1Ô∏è‚É£4Ô∏è‚É£ Comentar en PR
      - name: üí¨ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            let comment = '## üîí Reporte de Seguridad Autom√°tico\n\n';
            comment += '‚úÖ El an√°lisis de seguridad ha sido completado para este PR.\n\n';
            comment += '### üìä Resumen de verificaciones:\n';
            comment += '- ‚úÖ **Estructura del plugin** - Validada\n';
            comment += '- ‚úÖ **Verificaciones de seguridad** - Completadas\n';
            comment += '- ‚úÖ **Est√°ndares de codificaci√≥n** - Analizados\n';
            comment += '- ‚úÖ **An√°lisis est√°tico** - Ejecutado\n';
            comment += '- ‚úÖ **Permisos y capacidades** - Verificados\n';
            comment += '- ‚úÖ **Scripts de BD** - Validados\n\n';
            comment += '### üìÇ Artefactos generados:\n';
            comment += '`moodle-security-reports-${{ github.run_number }}`\n\n';
            comment += '### üîç ¬øQu√© hacer ahora?\n';
            comment += '1. Descarga los artefactos para revisar el reporte detallado\n';
            comment += '2. Corrige cualquier problema cr√≠tico encontrado\n';
            comment += '3. Los problemas menores pueden abordarse en commits futuros\n\n';
            comment += 'üí° **Nota:** Este es un an√°lisis automatizado. Siempre revisa manualmente el c√≥digo para seguridad adicional.';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      # 1Ô∏è‚É£5Ô∏è‚É£ Notificaci√≥n final
      - name: üéâ Final summary
        run: |
          echo "=================================================="
          echo "üéâ AN√ÅLISIS DE SEGURIDAD COMPLETADO"
          echo "=================================================="
          echo "üìä Rama: ${GITHUB_REF#refs/heads/}"
          echo "üîß PHP: ${{ env.PHP_VERSION }}"
          echo "üéØ Moodle: ${{ env.MOODLE_BRANCH }}"
          echo "‚è∞ Duraci√≥n: $SECONDS segundos"
          echo "=================================================="
          echo "‚úÖ Todas las verificaciones han sido completadas"
          echo "üìÇ Reportes disponibles en artefactos"
          echo "üîó Revisa el tab 'Actions' para m√°s detalles"
          echo "=================================================="