name: Moodle Plugin - Security & Coding Standards Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  moodle_security_check:
    name: Moodle Plugin Security & Standards
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Clonar el repositorio
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configurar PHP y herramientas
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'  # Ajusta seg√∫n la versi√≥n de Moodle que uses
          tools: composer, phpstan, phpcs
          extensions: mbstring, mysqli, xml, curl, intl, zip, json

      # 3Ô∏è‚É£ Validar archivo version.php
      - name: Validate version.php (minimum Moodle version)
        run: |
          echo "üîç Verificando archivo version.php..."
          php -r '
            $plugin = new stdClass(); // Crear antes de incluir
            include "version.php";
            if (!isset($plugin->requires)) {
                echo "‚ùå ERROR: No se encontr√≥ \$plugin->requires en version.php\n";
                exit(1);
            }
            if ($plugin->requires < 2020042000) {
                echo "‚ö†Ô∏è Advertencia: Moodle requerido muy antiguo (" . $plugin->requires . "). Considera actualizar a Moodle 4.x o posterior.\n";
                exit(0); # no falla, solo advierte
            }
            echo "‚úÖ version.php v√°lido (Moodle >= 4.0)\n";
          '

      # 4Ô∏è‚É£ Instalar Moodle Coding Standards (desde ZIP)
      - name: Install Moodle coding standards (PHP CodeSniffer)
        run: |
          echo "üì¶ Descargando moodlehq/moodle-codesniffer ZIP..."
          curl -L https://github.com/moodlehq/moodle-codesniffer/archive/refs/heads/master.zip -o /tmp/moodle-codesniffer.zip
          unzip -q /tmp/moodle-codesniffer.zip -d /tmp/
          phpcs --config-set installed_paths /tmp/moodle-codesniffer-master
          echo "üìò Est√°ndares instalados:"
          phpcs -i

      # 5Ô∏è‚É£ Ejecutar PHP CodeSniffer con est√°ndar Moodle
      - name: Run Moodle CodeSniffer
        run: |
          echo "üîé Verificando est√°ndares de codificaci√≥n Moodle..."
          phpcs --standard=Moodle --extensions=php --ignore=vendor,tests . || true
        continue-on-error: true

      # 6Ô∏è‚É£ Ejecutar PHPStan (An√°lisis est√°tico)
      - name: Run PHPStan (Static Analysis)
        run: |
          echo "üß† Ejecutando PHPStan para an√°lisis est√°tico..."
          phpstan analyse --level=max . || true
        continue-on-error: true

      # 7Ô∏è‚É£ Mostrar resumen final
      - name: Summary report
        run: |
          echo "-----------------------------------------"
          echo "‚úÖ Verificaci√≥n completada"
          echo "üìò Moodle coding standards: ejecutado"
          echo "üõ°Ô∏è  PHPStan: ejecutado"
          echo "-----------------------------------------"
