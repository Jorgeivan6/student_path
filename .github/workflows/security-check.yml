name: Moodle Code & Security Check

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  moodle-check:
    name: Run Moodle Code Checker
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4
        with:
          # --- ASEGÚRATE DE QUE ESTA LÍNEA ESTÉ AQUÍ ---
          persist-credentials: false

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '5.4'
          extensions: mbstring, mysqli, gd, intl, soap, xmlrpc, zip
          coverage: none

      - name: Clone Moodle Core
        run: git clone --depth 1 --branch MOODLE_25_STABLE https://github.com/moodle/moodle.git moodle

      - name: Clone Moodle Code Checker plugin
        run: git clone --depth 1 https://github.com/moodle/moodle-local_codechecker.git moodle/local/codechecker

      - name: Run Moodle Code Checker
        run: |
          php moodle/admin/tool/codechecker/cli/check.php --ci --show-summary ${{ github.workspace }}
