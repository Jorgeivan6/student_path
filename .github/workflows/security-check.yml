name: ðŸ”’ Moodle Security & Standards Check (Improved)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  MOODLE_BRANCH: MOODLE_404_STABLE
  PHP_VERSION: '8.1'

jobs:
  security_analysis:
    name: ðŸ›¡ï¸ Security Analysis & Standards
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer, phpstan, phpcs
          extensions: mbstring, mysqli, xml, curl, intl, zip, json, gd, soap

      - name: ðŸ“ Create reports directory
        run: mkdir -p reports

      - name: ðŸ—ï¸ Validate plugin structure
        run: |
          echo "ðŸ—ï¸ Validando estructura del plugin..."
          
          if [ ! -f "version.php" ]; then
            echo "âŒ ERROR: version.php no encontrado"
            exit 1
          fi
          
          php -r '
            $plugin = new stdClass();
            include "version.php";
            
            if (!isset($plugin->version) || !isset($plugin->component)) {
              echo "âŒ ERROR: Campos obligatorios faltantes en version.php\n";
              exit(1);
            }
            
            if (isset($plugin->requires) && $plugin->requires < 2022042000) {
              echo "âš ï¸ ADVERTENCIA: VersiÃ³n de Moodle muy antigua\n";
            }
            
            echo "âœ… Estructura del plugin vÃ¡lida\n";
          '

      - name: ðŸ”’ Critical Security Checks
        run: |
          echo "ðŸ”’ Ejecutando verificaciones de seguridad crÃ­ticas..."
          
          cat > security_check.php << 'EOF'
          <?php
          function check_security_issues($directory) {
              $security_issues = [];
              $critical_issues = [];
              $files = new RecursiveIteratorIterator(
                  new RecursiveDirectoryIterator($directory, RecursiveDirectoryIterator::SKIP_DOTS)
              );
              
              foreach ($files as $file) {
                  if ($file->getExtension() !== 'php') continue;
                  
                  $content = file_get_contents($file->getPathname());
                  $relative_path = str_replace($directory . '/', '', $file->getPathname());
                  
                  // Excluir archivos del anÃ¡lisis de seguridad
                  if (strpos($relative_path, 'security_check.php') !== false || 
                      strpos($relative_path, '.github/') !== false ||
                      strpos($relative_path, 'vendor/') !== false) {
                      continue;
                  }
                  
                  // 1. CRÃTICO: eval()
                  if (preg_match('/\beval\s*\(/i', $content)) {
                      $critical_issues[] = "ðŸš¨ CRÃTICO: eval() en $relative_path";
                  }
                  
                  // 2. CRÃTICO: Superglobales sin validaciÃ³n
                  if (preg_match('/\$_(GET|POST|REQUEST)\s*\[/', $content)) {
                      if (!preg_match('/(required_param|optional_param|clean_param)/', $content)) {
                          $critical_issues[] = "ðŸš¨ CRÃTICO: Superglobales sin validaciÃ³n en $relative_path";
                      }
                  }
                  
                  // 3. ALTO: SQL injection
                  if (preg_match('/\$DB\s*->\s*(execute|get_records_sql|get_record_sql)\s*\(\s*["\'][^"\']*[\{\$]/', $content)) {
                      $security_issues[] = "âš ï¸ ALTO: Posible SQL injection en $relative_path";
                  }
                  
                  // 4. ALTO: Include/require dinÃ¡mico
                  if (preg_match('/(include|require)(_once)?\s*\(\s*\$/', $content)) {
                      if (!preg_match('/(CFG->dirroot|CFG->libdir)/', $content)) {
                          $security_issues[] = "âš ï¸ ALTO: Include/require dinÃ¡mico en $relative_path";
                      }
                  }
                  
                  // 5. MEDIO: MOODLE_INTERNAL faltante
                  if (!preg_match('/defined\(.*MOODLE_INTERNAL.*\)/', $content) && 
                      !preg_match('/require.*config\.php/', $content) &&
                      !preg_match('/(ajax\/|version\.php)/', $relative_path)) {
                      $security_issues[] = "âš ï¸ MEDIO: MOODLE_INTERNAL faltante en $relative_path";
                  }
                  
                  // 6. CRÃTICO: Manejo de archivos
                  if (preg_match('/\$_FILES/', $content)) {
                      if (!preg_match('/(file_get_draft|file_save_draft|stored_file)/', $content)) {
                          $critical_issues[] = "ðŸš¨ CRÃTICO: Manejo inseguro de archivos en $relative_path";
                      }
                  }
              }
              
              return ['critical' => $critical_issues, 'security' => $security_issues];
          }
          
          $issues = check_security_issues('.');
          $exit_code = 0;
          
          echo "ðŸ” ANÃLISIS DE SEGURIDAD\n";
          echo "=======================\n";
          
          if (!empty($issues['critical'])) {
              echo "ðŸš¨ PROBLEMAS CRÃTICOS (" . count($issues['critical']) . "):\n";
              foreach ($issues['critical'] as $issue) {
                  echo "  $issue\n";
              }
              $exit_code = 1;
          }
          
          if (!empty($issues['security'])) {
              echo "\nâš ï¸ PROBLEMAS NO CRÃTICOS (" . count($issues['security']) . "):\n";
              foreach ($issues['security'] as $issue) {
                  echo "  $issue\n";
              }
              if ($exit_code === 0) $exit_code = 2;
          }
          
          if (empty($issues['critical']) && empty($issues['security'])) {
              echo "âœ… No se encontraron problemas de seguridad\n";
          }
          
          // Guardar reporte detallado
          file_put_contents('reports/security-issues.txt', 
              "PROBLEMAS CRÃTICOS:\n" . implode("\n", $issues['critical']) . 
              "\n\nPROBLEMAS NO CRÃTICOS:\n" . implode("\n", $issues['security']));
          
          echo "\n=======================\n";
          exit($exit_code);
          EOF
          
          php security_check.php
          SECURITY_EXIT_CODE=$?
          
          if [ $SECURITY_EXIT_CODE -eq 1 ]; then
            echo "âŒ FALLO: Problemas crÃ­ticos detectados"
            exit 1
          elif [ $SECURITY_EXIT_CODE -eq 2 ]; then
            echo "âš ï¸ ADVERTENCIA: Problemas no crÃ­ticos detectados"
          fi

      - name: ðŸ“¦ Install Moodle coding standards
        run: |
          composer global config allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
          composer global require moodlehq/moodle-coding-standard --no-progress
          phpcs --config-set installed_paths ~/.composer/vendor/moodlehq/moodle-coding-standard

      - name: ðŸ” Run Moodle CodeSniffer
        continue-on-error: true
        run: |
          phpcs --standard=Moodle \
                --extensions=php \
                --ignore=vendor,tests,node_modules,.github,security_check.php \
                --report=full \
                --report-file=reports/phpcs-report.txt \
                . || true

      - name: ðŸ“Š Generate security summary
        if: always()
        run: |
          cat > reports/security-summary.md << EOF
          # ðŸ”’ Reporte de Seguridad - Plugin Moodle
          
          **Fecha:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          **Rama:** \`${GITHUB_REF#refs/heads/}\`
          **Commit:** \`${GITHUB_SHA:0:8}\`
          
          ## ðŸ“‹ Verificaciones Realizadas
          
          - âœ… Estructura del plugin
          - âœ… Verificaciones de seguridad crÃ­ticas
          - âœ… EstÃ¡ndares de codificaciÃ³n Moodle
          
          ## ðŸ“‚ Archivos de Reporte
          
          - \`security-issues.txt\` - Problemas de seguridad detectados
          - \`phpcs-report.txt\` - Violaciones de estÃ¡ndares de codificaciÃ³n
          
          ## ðŸ”— PrÃ³ximos Pasos
          
          1. Revisar los problemas crÃ­ticos en \`security-issues.txt\`
          2. Corregir las vulnerabilidades de SQL injection
          3. Agregar verificaciones MOODLE_INTERNAL faltantes
          4. Validar includes/requires dinÃ¡micos
          EOF

      - name: ðŸ“¤ Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: moodle-security-reports-${{ github.run_number }}
          path: reports/
          retention-days: 30

      - name: ðŸŽ‰ Security analysis complete
        run: |
          echo "âœ… AnÃ¡lisis de seguridad completado"
          echo "ðŸ“‚ Descarga los artefactos para ver el reporte detallado"