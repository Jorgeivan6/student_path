name: üîí Complete Moodle Security Analysis

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch: # Permite ejecutar manualmente

env:
  MOODLE_BRANCH: MOODLE_404_STABLE
  PHP_VERSION: '8.1'

jobs:
  complete_security_analysis:
    name: üõ°Ô∏è Complete Security & Standards Analysis
    runs-on: ubuntu-latest
    
    steps:
      # 1Ô∏è‚É£ Clonar el repositorio
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Configurar PHP y herramientas
      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer, phpstan, phpcs
          extensions: mbstring, mysqli, xml, curl, intl, zip, json, gd, soap

      # 3Ô∏è‚É£ Crear directorio de reportes (NUNCA FALLA)
      - name: üìÅ Create reports directory
        continue-on-error: true
        run: |
          mkdir -p reports
          echo "üìÅ Directorio de reportes creado exitosamente"

      # 4Ô∏è‚É£ An√°lisis de seguridad COMPLETO (NUNCA FALLA)
      - name: üîí Complete Security Analysis
        continue-on-error: true
        run: |
          echo "üîí === AN√ÅLISIS COMPLETO DE SEGURIDAD ===" | tee reports/security-analysis.txt
          
          cat > security_scanner.php << 'EOF'
          <?php
          function analyze_complete_security($directory) {
              $results = [
                  'critical' => [], 'high' => [], 'medium' => [], 'low' => [], 'info' => [],
                  'files_scanned' => 0, 'total_issues' => 0
              ];
              
              $iterator = new RecursiveIteratorIterator(
                  new RecursiveDirectoryIterator($directory, RecursiveDirectoryIterator::SKIP_DOTS)
              );
              
              foreach ($iterator as $file) {
                  if ($file->getExtension() !== 'php') continue;
                  
                  $content = file_get_contents($file->getPathname());
                  $path = str_replace($directory . '/', '', $file->getPathname());
                  
                  // Skip temporary files
                  if (strpos($path, 'security_scanner.php') !== false || 
                      strpos($path, '.github/') !== false || 
                      strpos($path, 'vendor/') !== false) {
                      continue;
                  }
                  
                  $results['files_scanned']++;
                  
                  // CRITICAL: eval() usage
                  if (preg_match('/\beval\s*\(/i', $content)) {
                      $results['critical'][] = "üö® CR√çTICO: eval() en $path";
                  }
                  
                  // CRITICAL: Superglobals without validation
                  if (preg_match('/\$_(GET|POST|REQUEST|COOKIE)\s*\[/', $content)) {
                      if (!preg_match('/(required_param|optional_param|clean_param)/', $content)) {
                          $results['critical'][] = "üö® CR√çTICO: Superglobales sin validaci√≥n en $path";
                      }
                  }
                  
                  // HIGH: SQL injection potential
                  if (preg_match('/\$DB.*get_record.*sql.*\$/', $content)) {
                      if (!preg_match('/\?\s*[,\)]/', $content)) {
                          $results['high'][] = "‚ö†Ô∏è ALTO: Posible SQL injection en $path";
                      }
                  }
                  
                  // HIGH: XSS potential
                  if (preg_match('/\b(echo|print)\s+\$/', $content)) {
                      if (!preg_match('/(htmlspecialchars|s\(|format_string)/', $content)) {
                          $results['high'][] = "‚ö†Ô∏è ALTO: Posible XSS en $path";
                      }
                  }
                  
                  // HIGH: Dynamic includes
                  if (preg_match('/(include|require).*\$/', $content)) {
                      if (!preg_match('/(CFG->dirroot|CFG->libdir)/', $content)) {
                          $results['high'][] = "‚ö†Ô∏è ALTO: Include din√°mico en $path";
                      }
                  }
                  
                  // MEDIUM: Missing MOODLE_INTERNAL
                  if (!preg_match('/defined\(.*MOODLE_INTERNAL.*\)/', $content) && 
                      !preg_match('/require.*config\.php/', $content) &&
                      !preg_match('/(ajax\/|version\.php)/', $path)) {
                      $results['medium'][] = "‚ö†Ô∏è MEDIO: MOODLE_INTERNAL faltante en $path";
                  }
                  
                  // MEDIUM: Missing require_login
                  if (preg_match('/\$USER|\$COURSE/', $content) && 
                      !preg_match('/lang\/|version\.php|db\//', $path)) {
                      if (!preg_match('/require_login/', $content)) {
                          $results['medium'][] = "‚ö†Ô∏è MEDIO: require_login() faltante en $path";
                      }
                  }
                  
                  // CRITICAL: File upload without validation
                  if (preg_match('/\$_FILES/', $content)) {
                      if (!preg_match('/(file_get_draft|stored_file)/', $content)) {
                          $results['critical'][] = "üö® CR√çTICO: Upload inseguro en $path";
                      }
                  }
                  
                  // LOW: Hardcoded credentials
                  if (preg_match('/(password|pwd|secret)\s*=\s*["\']/', $content)) {
                      $results['low'][] = "‚ÑπÔ∏è BAJO: Credenciales hardcoded en $path";
                  }
                  
                  // INFO: Deprecated functions
                  if (preg_match('/(mysql_|eregi|split\(|each\()/', $content)) {
                      $results['info'][] = "üìã INFO: Funciones deprecated en $path";
                  }
              }
              
              $results['total_issues'] = count($results['critical']) + count($results['high']) + 
                                       count($results['medium']) + count($results['low']) + 
                                       count($results['info']);
              
              return $results;
          }
          
          // Execute complete analysis
          echo "üîç Iniciando an√°lisis completo de seguridad...\n";
          $analysis = analyze_complete_security('.');
          
          echo "üìä RESUMEN EJECUTIVO\n";
          echo "===================\n";
          echo "üìÅ Archivos escaneados: " . $analysis['files_scanned'] . "\n";
          echo "üö® Cr√≠ticos: " . count($analysis['critical']) . "\n";
          echo "‚ö†Ô∏è Altos: " . count($analysis['high']) . "\n";
          echo "‚ö†Ô∏è Medios: " . count($analysis['medium']) . "\n";
          echo "‚ÑπÔ∏è Bajos: " . count($analysis['low']) . "\n";
          echo "üìã Info: " . count($analysis['info']) . "\n";
          echo "üìä TOTAL: " . $analysis['total_issues'] . " problemas\n";
          echo "===================\n\n";
          
          // Display all issues
          foreach (['critical' => 'CR√çTICOS', 'high' => 'ALTOS', 'medium' => 'MEDIOS', 
                   'low' => 'BAJOS', 'info' => 'INFORMACI√ìN'] as $level => $label) {
              if (!empty($analysis[$level])) {
                  echo "üîç PROBLEMAS $label (" . count($analysis[$level]) . "):\n";
                  foreach ($analysis[$level] as $issue) {
                      echo "  $issue\n";
                  }
                  echo "\n";
              }
          }
          
          if ($analysis['total_issues'] == 0) {
              echo "üéâ ¬°EXCELENTE! No se encontraron problemas de seguridad.\n";
          }
          
          // Save detailed report
          file_put_contents('reports/security-detailed-report.txt', 
              "AN√ÅLISIS COMPLETO DE SEGURIDAD\n" .
              "==============================\n\n" .
              "Archivos analizados: " . $analysis['files_scanned'] . "\n" .
              "Total problemas: " . $analysis['total_issues'] . "\n\n" .
              "DESGLOSE POR SEVERIDAD:\n" .
              "- Cr√≠ticos: " . count($analysis['critical']) . "\n" .
              "- Altos: " . count($analysis['high']) . "\n" .
              "- Medios: " . count($analysis['medium']) . "\n" .
              "- Bajos: " . count($analysis['low']) . "\n" .
              "- Informativos: " . count($analysis['info']) . "\n\n" .
              implode("\n", array_merge($analysis['critical'], $analysis['high'], 
                                      $analysis['medium'], $analysis['low'], $analysis['info']))
          );
          
          echo "‚úÖ An√°lisis de seguridad completado - Reporte guardado\n";
          EOF
          
          php security_scanner.php | tee -a reports/security-analysis.txt


      # 5Ô∏è‚É£ Instalar herramientas con Moodle Standard 
      - name: üì¶ Install analysis tools with Moodle Standard
        continue-on-error: true
        run: |
          echo "üì¶ === INSTALACI√ìN COMPLETA CON EST√ÅNDAR MOODLE ===" | tee reports/tools-installation.txt
          
          # Configurar Composer
          composer global config allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
          composer global config minimum-stability dev
          composer global config prefer-stable true
          
          echo "üîß Instalando PHPStan..." | tee -a reports/tools-installation.txt
          composer global require phpstan/phpstan --no-progress 2>&1 | tee -a reports/tools-installation.txt || echo "‚ö†Ô∏è PHPStan installation had issues but continuing..."
          
          echo "üîß Instalando PHP CodeSniffer..." | tee -a reports/tools-installation.txt
          composer global require squizlabs/php_codesniffer --no-progress 2>&1 | tee -a reports/tools-installation.txt || echo "‚ö†Ô∏è PHPCS installation had issues but continuing..."
          
          echo "üîß Instalando plugin de PHPCS..." | tee -a reports/tools-installation.txt
          composer global require dealerdirect/phpcodesniffer-composer-installer --no-progress 2>&1 | tee -a reports/tools-installation.txt || echo "‚ö†Ô∏è Plugin installation had issues but continuing..."
          
          echo "üì• Instalando Moodle Coding Standard desde GitHub..." | tee -a reports/tools-installation.txt
          
          # Crear directorio para est√°ndares personalizados
          mkdir -p ~/.phpcs/standards
          
          # Clonar el repositorio oficial de Moodle CS
          if git clone https://github.com/moodlehq/moodle-cs.git ~/.phpcs/standards/moodle-cs 2>&1 | tee -a reports/tools-installation.txt; then
            echo "‚úÖ Moodle CS clonado exitosamente" | tee -a reports/tools-installation.txt
            
            # Configurar PHPCS para usar el est√°ndar de Moodle
            if command -v phpcs &> /dev/null; then
              phpcs --config-set installed_paths ~/.phpcs/standards/moodle-cs 2>&1 | tee -a reports/tools-installation.txt
              echo "‚úÖ Moodle standard configurado en PHPCS" | tee -a reports/tools-installation.txt
            else
              echo "‚ö†Ô∏è PHPCS no disponible para configurar" | tee -a reports/tools-installation.txt
            fi
          else
            echo "‚ö†Ô∏è No se pudo clonar Moodle CS, intentando m√©todo alternativo..." | tee -a reports/tools-installation.txt
            
            # M√©todo alternativo: descargar ZIP
            curl -L https://github.com/moodlehq/moodle-cs/archive/refs/heads/main.zip -o moodle-cs.zip 2>&1 | tee -a reports/tools-installation.txt
            if [ -f "moodle-cs.zip" ]; then
              unzip -q moodle-cs.zip
              mv moodle-cs-main ~/.phpcs/standards/moodle-cs
              phpcs --config-set installed_paths ~/.phpcs/standards/moodle-cs 2>&1 | tee -a reports/tools-installation.txt || true
              echo "‚úÖ Moodle CS instalado desde ZIP" | tee -a reports/tools-installation.txt
              rm -f moodle-cs.zip
            else
              echo "‚ö†Ô∏è Usando est√°ndares b√°sicos como fallback" | tee -a reports/tools-installation.txt
            fi
          fi
          
          echo "üìã Verificando instalaci√≥n completa:" | tee -a reports/tools-installation.txt
          
          # Verificar PHPStan
          if command -v phpstan &> /dev/null; then
            phpstan_version=$(phpstan --version 2>/dev/null || echo 'instalado')
            echo "‚úÖ PHPStan: $phpstan_version" | tee -a reports/tools-installation.txt
          else
            echo "‚ö†Ô∏è PHPStan no disponible" | tee -a reports/tools-installation.txt
          fi
          
          # Verificar PHPCS y est√°ndares
          if command -v phpcs &> /dev/null; then
            phpcs_version=$(phpcs --version 2>/dev/null || echo 'instalado')
            echo "‚úÖ PHPCS: $phpcs_version" | tee -a reports/tools-installation.txt
            
            echo "üìã Est√°ndares de codificaci√≥n disponibles:" | tee -a reports/tools-installation.txt
            phpcs -i 2>&1 | tee -a reports/tools-installation.txt
            
            # Verificar espec√≠ficamente si Moodle est√° disponible
            if phpcs -i | grep -q "Moodle"; then
              echo "üéâ ¬°Est√°ndar Moodle disponible!" | tee -a reports/tools-installation.txt
            else
              echo "‚ö†Ô∏è Est√°ndar Moodle no detectado, usaremos PSR12" | tee -a reports/tools-installation.txt
            fi
          else
            echo "‚ö†Ô∏è PHPCS no disponible" | tee -a reports/tools-installation.txt
          fi
          
          echo "‚úÖ Instalaci√≥n con Moodle Standard completada" | tee -a reports/tools-installation.txt



      # 6Ô∏è‚É£ CodeSniffer con Est√°ndar Moodle
      - name: üîç Moodle CodeSniffer Analysis
        continue-on-error: true
        run: |
          echo "üîç === AN√ÅLISIS CON EST√ÅNDAR MOODLE ===" | tee reports/coding-standards.txt
          
          if command -v phpcs &> /dev/null; then
            echo "üìä Ejecutando PHPCS con est√°ndar Moodle..." | tee -a reports/coding-standards.txt
            
            # Verificar si Moodle standard est√° disponible
            if phpcs -i | grep -q "Moodle"; then
              echo "‚úÖ Usando est√°ndar oficial de Moodle" | tee -a reports/coding-standards.txt
              STANDARD="Moodle"
            else
              echo "‚ö†Ô∏è Est√°ndar Moodle no disponible, usando PSR12" | tee -a reports/coding-standards.txt
              STANDARD="PSR12"
            fi
            
            # Reporte completo con est√°ndar Moodle
            phpcs --standard=$STANDARD \
                  --extensions=php \
                  --ignore=vendor,tests,node_modules,.github,security_scanner.php \
                  --report=full \
                  --report-file=reports/phpcs-moodle-report.txt \
                  . 2>&1 || true
            
            # Reporte de resumen
            phpcs --standard=$STANDARD \
                  --extensions=php \
                  --ignore=vendor,tests,node_modules,.github,security_scanner.php \
                  --report=summary \
                  . 2>&1 | tee -a reports/coding-standards.txt || true
            
            # Estad√≠sticas espec√≠ficas de Moodle
            if [ "$STANDARD" = "Moodle" ]; then
              echo "üìä An√°lisis espec√≠fico con reglas de Moodle:" | tee -a reports/coding-standards.txt
              violations=$(grep -c "ERROR\|WARNING" reports/phpcs-moodle-report.txt 2>/dev/null || echo "0")
              echo "üìà Violaciones encontradas: $violations" | tee -a reports/coding-standards.txt
            fi
            
          else
            echo "‚ö†Ô∏è PHPCS no disponible - saltando an√°lisis de est√°ndares" | tee -a reports/coding-standards.txt
          fi
          
          echo "‚úÖ An√°lisis de est√°ndares Moodle completado" | tee -a reports/coding-standards.txt

      # 7Ô∏è‚É£ PHPStan completo (NUNCA FALLA)
      - name: üß† Complete PHPStan Analysis
        continue-on-error: true
        run: |
          echo "üß† === AN√ÅLISIS EST√ÅTICO PHPSTAN ===" | tee reports/phpstan-analysis.txt
          
          cat > phpstan.neon << EOF
          parameters:
              level: 6
              paths: [.]
              excludePaths:
                  - vendor
                  - tests
                  - node_modules
                  - .github
                  - security_scanner.php
              ignoreErrors:
                  - '#Undefined variable: \$CFG#'
                  - '#Undefined variable: \$DB#'
                  - '#Undefined variable: \$USER#'
                  - '#Undefined variable: \$COURSE#'
                  - '#Undefined variable: \$PAGE#'
                  - '#Undefined variable: \$OUTPUT#'
          EOF
          
          phpstan analyse --configuration=phpstan.neon \
                         --error-format=table \
                         --no-progress \
                         2>&1 | tee reports/phpstan-complete-report.txt || true
          
          echo "‚úÖ An√°lisis est√°tico completado" | tee -a reports/phpstan-analysis.txt

      # 8Ô∏è‚É£ Verificaciones adicionales (NUNCA FALLA)
      - name: üîê Additional Security Checks
        continue-on-error: true
        run: |
          echo "üîê === VERIFICACIONES ADICIONALES ===" | tee reports/additional-checks.txt
          
          # Check capabilities
          if [ -f "db/access.php" ]; then
            echo "‚úÖ db/access.php encontrado" | tee -a reports/additional-checks.txt
          else
            echo "‚ÑπÔ∏è db/access.php no encontrado" | tee -a reports/additional-checks.txt
          fi
          
          # Check database scripts
          if [ -f "db/upgrade.php" ]; then
            echo "‚úÖ db/upgrade.php encontrado" | tee -a reports/additional-checks.txt
            php -l db/upgrade.php 2>&1 | tee -a reports/additional-checks.txt
          fi
          
          # Check language files
          lang_files=$(find lang/ -name "*.php" 2>/dev/null | wc -l || echo "0")
          echo "üìä Archivos de idioma encontrados: $lang_files" | tee -a reports/additional-checks.txt
          
          echo "‚úÖ Verificaciones adicionales completadas" | tee -a reports/additional-checks.txt

      # 9Ô∏è‚É£ Generar reporte final COMPLETO (SIEMPRE SE EJECUTA)
      - name: üìä Generate Complete Final Report
        if: always()
        run: |
          echo "üìä === GENERANDO REPORTE FINAL COMPLETO ==="
          
          cat > reports/COMPLETE-SECURITY-ANALYSIS.md << EOF
          # üîí An√°lisis Completo de Seguridad - Moodle Plugin
          
          ## üìÖ Informaci√≥n del An√°lisis
          - **Fecha:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          - **Rama:** \`${GITHUB_REF#refs/heads/}\`
          - **Commit:** \`${GITHUB_SHA:0:8}\`
          - **PHP:** ${{ env.PHP_VERSION }}
          - **Workflow:** NUNCA FALLA - An√°lisis Completo
          
          ## ‚úÖ Estado del An√°lisis
          
          ‚úÖ **COMPLETADO EXITOSAMENTE** - Todos los an√°lisis terminaron
          
          ## üìã Verificaciones Realizadas
          
          | An√°lisis | Estado | Archivo de Reporte |
          |----------|--------|-------------------|
          | üîí Seguridad completa | ‚úÖ Completado | security-analysis.txt |
          | üì¶ Instalaci√≥n herramientas | ‚úÖ Completado | tools-installation.txt |
          | üîç Est√°ndares codificaci√≥n | ‚úÖ Completado | coding-standards.txt |
          | üß† An√°lisis est√°tico | ‚úÖ Completado | phpstan-analysis.txt |
          | üîê Verificaciones adicionales | ‚úÖ Completado | additional-checks.txt |
          
          ## üìÇ Archivos de Reporte Disponibles
          
          - **\`security-detailed-report.txt\`** - Problemas de seguridad detallados
          - **\`phpcs-complete-report.txt\`** - Reporte completo de CodeSniffer
          - **\`phpstan-complete-report.txt\`** - An√°lisis completo de PHPStan
          - **\`security-analysis.txt\`** - Log del an√°lisis de seguridad
          - **\`coding-standards.txt\`** - Log de est√°ndares de codificaci√≥n
          - **\`phpstan-analysis.txt\`** - Log de an√°lisis est√°tico
          - **\`additional-checks.txt\`** - Verificaciones adicionales
          
          ## üéØ C√≥mo Usar Este Reporte
          
          1. **Descarga los artefactos** desde GitHub Actions
          2. **Revisa primero** \`security-detailed-report.txt\`
          3. **Prioriza problemas cr√≠ticos** marcados como üö® CR√çTICO
          4. **Corrige gradualmente** problemas de menor severidad
          5. **Ejecuta nuevamente** para verificar correcciones
          
          ## üìä M√©tricas del An√°lisis
          
          - Total de archivos PHP analizados: $(find . -name "*.php" -not -path "./.github/*" | wc -l)
          - Tiempo de ejecuci√≥n: Workflow completo
          - Herramientas utilizadas: PHPCS, PHPStan, Scanner personalizado
          
          ## üí° Caracter√≠sticas de Este Workflow
          
          - ‚úÖ **NUNCA FALLA**: Siempre completa todo el an√°lisis
          - üîÑ **COMPLETO**: Analiza todos los aspectos de seguridad
          - üìä **DETALLADO**: Genera reportes exhaustivos
          - üéØ **PRIORIZADO**: Clasifica problemas por severidad
          - üìÇ **PERSISTENTE**: Guarda todos los reportes (30 d√≠as)
          
          ## üîó Recursos √ötiles
          
          - [Moodle Security Guidelines](https://docs.moodle.org/dev/Security)
          - [Moodle Coding Standards](https://docs.moodle.org/dev/Coding_style)
          - [SQL Injection Prevention](https://docs.moodle.org/dev/SQL_injection_prevention)
          
          ---
          **An√°lisis generado autom√°ticamente - $(date)**
          EOF
          
          echo "‚úÖ Reporte final completo generado exitosamente"

      # üîü Subir TODOS los artefactos (SIEMPRE)
      - name: üì§ Upload Complete Analysis Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: complete-security-analysis-${{ github.run_number }}
          path: reports/
          retention-days: 30

      # 1Ô∏è‚É£1Ô∏è‚É£ Notificaci√≥n final (SIEMPRE EXITOSA)
      - name: üéâ Analysis Complete - Always Success
        if: always()
        run: |
          echo "=================================================="
          echo "üéâ AN√ÅLISIS COMPLETO TERMINADO EXITOSAMENTE"
          echo "=================================================="
          echo "‚úÖ TODOS los an√°lisis completados"
          echo "üìÇ TODOS los reportes generados"
          echo "üéØ Artefactos listos para descarga"
          echo "‚è∞ Workflow NUNCA falla"
          echo "=================================================="
          echo ""
          echo "üîç LO QUE SE ANALIZ√ì:"
          echo "- Vulnerabilidades de seguridad cr√≠ticas"
          echo "- Est√°ndares de codificaci√≥n Moodle"
          echo "- An√°lisis est√°tico con PHPStan"
          echo "- Verificaciones adicionales de Moodle"
          echo ""
          echo "üìã PR√ìXIMOS PASOS:"
          echo "1. Descarga artefacto: complete-security-analysis-${{ github.run_number }}"
          echo "2. Revisa: COMPLETE-SECURITY-ANALYSIS.md"
          echo "3. Prioriza: security-detailed-report.txt"
          echo "4. Corrige problemas encontrados"
          echo "5. Ejecuta nuevamente para verificar"
          echo "=================================================="







          








          # 4Ô∏è‚É£ An√°lisis de seguridad COMPLETO (CON N√öMERO DE L√çNEA)
      - name: üîí Complete Security Analysis
        continue-on-error: true
        run: |
          echo "üîí === AN√ÅLISIS COMPLETO DE SEGURIDAD ===" | tee reports/security-analysis.txt
          
          cat > security_scanner.php << 'EOF'
          <?php
          function analyze_complete_security($directory) {
              $results = [
                  'critical' => [], 'high' => [], 'medium' => [], 'low' => [], 'info' => [],
                  'files_scanned' => 0, 'total_issues' => 0
              ];
              
              $iterator = new RecursiveIteratorIterator(
                  new RecursiveDirectoryIterator($directory, RecursiveDirectoryIterator::SKIP_DOTS)
              );
              
              foreach ($iterator as $file) {
                  if ($file->getExtension() !== 'php') continue;
                  
                  $filepath = $file->getPathname();
                  $path = str_replace($directory . '/', '', $filepath);
                  
                  // Skip temporary files
                  if (strpos($path, 'security_scanner.php') !== false || 
                      strpos($path, '.github/') !== false || 
                      strpos($path, 'vendor/') !== false) {
                      continue;
                  }
                  
                  $results['files_scanned']++;
                  
                  // Read content for context checks (Global validations)
                  $content = file_get_contents($filepath);
                  // Read as array for line numbers
                  $lines = file($filepath); 
                  
                  // Context flags (to preserve logic: if validation exists in file, ignore specific lines)
                  $hasParamValidation = preg_match('/(required_param|optional_param|clean_param)/', $content);
                  $hasSqlPlaceholders = preg_match('/\?\s*[,\)]/', $content);
                  $hasXssProtection   = preg_match('/(htmlspecialchars|s\(|format_string)/', $content);
                  $validIncludeRoot   = preg_match('/(CFG->dirroot|CFG->libdir)/', $content);
                  $hasMoodleInternal  = preg_match('/defined\(.*MOODLE_INTERNAL.*\)/', $content) || 
                                        preg_match('/require.*config\.php/', $content) ||
                                        preg_match('/(ajax\/|version\.php)/', $path);
                  $hasRequireLogin    = preg_match('/require_login/', $content) || 
                                        preg_match('/lang\/|version\.php|db\//', $path);
                  $hasSafeUpload      = preg_match('/(file_get_draft|stored_file)/', $content);

                  // Iterate line by line to find the error location
                  foreach ($lines as $index => $line) {
                      $ln = $index + 1; // Line number (1-based)
                      $loc = "$path:$ln"; // Format: file.php:10

                      // CRITICAL: eval() usage
                      if (preg_match('/\beval\s*\(/i', $line)) {
                          $results['critical'][] = "üö® CR√çTICO: eval() en $loc";
                      }
                      
                      // CRITICAL: Superglobals without validation
                      if (preg_match('/\$_(GET|POST|REQUEST|COOKIE)\s*\[/', $line)) {
                          if (!$hasParamValidation) {
                              $results['critical'][] = "üö® CR√çTICO: Superglobales sin validaci√≥n en $loc";
                          }
                      }
                      
                      // HIGH: SQL injection potential
                      if (preg_match('/\$DB.*get_record.*sql.*\$/', $line)) {
                          if (!$hasSqlPlaceholders) {
                              $results['high'][] = "‚ö†Ô∏è ALTO: Posible SQL injection en $loc";
                          }
                      }
                      
                      // HIGH: XSS potential
                      if (preg_match('/\b(echo|print)\s+\$/', $line)) {
                          if (!$hasXssProtection) {
                              $results['high'][] = "‚ö†Ô∏è ALTO: Posible XSS en $loc";
                          }
                      }
                      
                      // HIGH: Dynamic includes
                      if (preg_match('/(include|require).*\$/', $line)) {
                          if (!$validIncludeRoot) {
                              $results['high'][] = "‚ö†Ô∏è ALTO: Include din√°mico en $loc";
                          }
                      }
                      
                      // CRITICAL: File upload without validation
                      if (preg_match('/\$_FILES/', $line)) {
                          if (!$hasSafeUpload) {
                              $results['critical'][] = "üö® CR√çTICO: Upload inseguro en $loc";
                          }
                      }
                      
                      // LOW: Hardcoded credentials
                      if (preg_match('/(password|pwd|secret)\s*=\s*["\']/', $line)) {
                          $results['low'][] = "‚ÑπÔ∏è BAJO: Credenciales hardcoded en $loc";
                      }
                      
                      // INFO: Deprecated functions
                      if (preg_match('/(mysql_|eregi|split\(|each\()/', $line)) {
                          $results['info'][] = "üìã INFO: Funciones deprecated en $loc";
                      }
                  }

                  // Checks that apply to the whole file, not specific lines (Reported on line 1 or 0)
                  
                  // MEDIUM: Missing MOODLE_INTERNAL
                  if (!$hasMoodleInternal) {
                      $results['medium'][] = "‚ö†Ô∏è MEDIO: MOODLE_INTERNAL faltante en $path (Global)";
                  }
                  
                  // MEDIUM: Missing require_login (Conditional logic kept from original)
                  if (preg_match('/\$USER|\$COURSE/', $content) && !$hasRequireLogin) {
                      $results['medium'][] = "‚ö†Ô∏è MEDIO: require_login() faltante en $path (Global)";
                  }
              }
              
              $results['total_issues'] = count($results['critical']) + count($results['high']) + 
                                       count($results['medium']) + count($results['low']) + 
                                       count($results['info']);
              
              return $results;
          }
          
          // Execute complete analysis
          echo "üîç Iniciando an√°lisis completo de seguridad...\n";
          $analysis = analyze_complete_security('.');
          
          echo "üìä RESUMEN EJECUTIVO\n";
          echo "===================\n";
          echo "üìÅ Archivos escaneados: " . $analysis['files_scanned'] . "\n";
          echo "üö® Cr√≠ticos: " . count($analysis['critical']) . "\n";
          echo "‚ö†Ô∏è Altos: " . count($analysis['high']) . "\n";
          echo "‚ö†Ô∏è Medios: " . count($analysis['medium']) . "\n";
          echo "‚ÑπÔ∏è Bajos: " . count($analysis['low']) . "\n";
          echo "üìã Info: " . count($analysis['info']) . "\n";
          echo "üìä TOTAL: " . $analysis['total_issues'] . " problemas\n";
          echo "===================\n\n";
          
          // Display all issues
          foreach (['critical' => 'CR√çTICOS', 'high' => 'ALTOS', 'medium' => 'MEDIOS', 
                    'low' => 'BAJOS', 'info' => 'INFORMACI√ìN'] as $level => $label) {
              if (!empty($analysis[$level])) {
                  echo "üîç PROBLEMAS $label (" . count($analysis[$level]) . "):\n";
                  foreach ($analysis[$level] as $issue) {
                      echo "  $issue\n";
                  }
                  echo "\n";
              }
          }
          
          if ($analysis['total_issues'] == 0) {
              echo "üéâ ¬°EXCELENTE! No se encontraron problemas de seguridad.\n";
          }
          
          // Save detailed report
          file_put_contents('reports/security-detailed-report.txt', 
              "AN√ÅLISIS COMPLETO DE SEGURIDAD\n" .
              "==============================\n\n" .
              "Archivos analizados: " . $analysis['files_scanned'] . "\n" .
              "Total problemas: " . $analysis['total_issues'] . "\n\n" .
              "DESGLOSE POR SEVERIDAD:\n" .
              "- Cr√≠ticos: " . count($analysis['critical']) . "\n" .
              "- Altos: " . count($analysis['high']) . "\n" .
              "- Medios: " . count($analysis['medium']) . "\n" .
              "- Bajos: " . count($analysis['low']) . "\n" .
              "- Informativos: " . count($analysis['info']) . "\n\n" .
              implode("\n", array_merge($analysis['critical'], $analysis['high'], 
                                      $analysis['medium'], $analysis['low'], $analysis['info']))
          );
          
          echo "‚úÖ An√°lisis de seguridad completado - Reporte guardado\n";
          EOF
          
          php security_scanner.php | tee -a reports/security-analysis.txt